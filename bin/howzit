#!/usr/bin/env ruby -W1
# frozen_string_literal: true

$LOAD_PATH.unshift File.join(__dir__, '..', 'lib')
require 'howzit'

Howzit::Color.coloring = $stdout.isatty
how = Howzit.buildnote

parts = Shellwords.shelljoin(ARGV).split(/ -- /)
args = parts[0] ? Shellwords.shellsplit(parts[0]) : []
Howzit.arguments = parts[1] ? Shellwords.shellsplit(parts[1]) : []

OptionParser.new do |opts|
  opts.banner = "Usage: #{__FILE__} [OPTIONS] [TOPIC]"
  opts.separator ''
  opts.separator 'Show build notes for the current project (buildnotes.md).
  Include a topic name to see just that topic, or no argument to display all.'
  opts.separator ''
  opts.separator 'Options:'

  opts.on('-c', '--create', 'Create a skeleton build note in the current working directory') do
    create_note
    Process.exit 0
  end

  opts.on('-e', '--edit', "Edit buildnotes file in current working directory
          using $EDITOR") do
    Howzit.buildnote.edit
    Process.exit 0
  end

  opts.on('--grep PATTERN', 'Display sections matching a search pattern') do |pat|
    Howzit.options[:grep] = pat
  end

  opts.on('-L', '--list-completions', 'List topics for completion') do
    Howzit.options[:list_topics] = true
    Howzit.options[:list_topic_titles] = true
  end

  opts.on('-l', '--list', 'List available topics') do
    Howzit.options[:list_topics] = true
  end

  opts.on('-m', '--matching TYPE', MATCHING_OPTIONS,
          'Topics matching type', "(#{MATCHING_OPTIONS.join(', ')})") do |c|
    Howzit.options[:matching] = c
  end

  opts.on('--multiple TYPE', MULTIPLE_OPTIONS,
          'Multiple result handling', "(#{MULTIPLE_OPTIONS.join(', ')}, default choose)") do |c|
    Howzit.options[:multiple_matches] = c.to_sym
  end

  opts.on('-R', '--list-runnable', 'List topics containing @ directives (verbose)') do
    Howzit.options[:list_runnable] = true
  end

  opts.on('-r', '--run', 'Execute @run, @open, and/or @copy commands for given topic') do
    Howzit.options[:run] = true
  end

  opts.on('-s', '--select', 'Select topic from menu') do
    Howzit.options[:choose] = true
  end

  opts.on('-T', '--task-list', 'List topics containing @ directives (completion-compatible)') do
    Howzit.options[:list_runnable] = true
    Howzit.options[:list_runnable_titles] = true
  end

  opts.on('-t', '--title', 'Output title with build notes') do
    Howzit.options[:output_title] = true
  end

  opts.on('-q', '--quiet', 'Silence info message') do
    Howzit.options[:log_level] = 3
  end

  opts.on('-v', '--verbose', 'Show all messages') do
    Howzit.options[:log_level] = 0
  end

  opts.on('-u', '--[no-]upstream', 'Traverse up parent directories for additional build notes') do |p|
    Howzit.options[:include_upstream] = p
  end

  opts.on('--show-code', 'Display the content of fenced run blocks') do
    Howzit.options[:show_all_code] = true
  end

  opts.on('-w', '--wrap COLUMNS', 'Wrap to specified width (default 80, 0 to disable)') do |w|
    Howzit.options[:wrap] = w.to_i
  end

  opts.on('--config-get [KEY]', 'Display the configuration settings or setting for a specific key') do |k|

    if k.nil?
      Howzit.options.sort_by { |key, _| key }.each do |key, val|
        print "#{key}: "
        p val
      end
    else
      k.sub!(/^:/, '')
      if Howzit.options.key?(k.to_sym)
        puts Howzit.options[k.to_sym]
      else
        puts "Key #{k} not found"
      end
    end
    Process.exit 0
  end

  opts.on('--config-set KEY=VALUE', 'Set a config value (must be a valid key)') do |key|
    raise 'Argument must be KEY=VALUE' unless key =~ /\S=\S/

    parts = key.split(/=/)
    k = parts[0].sub(/^:/, '')
    v = parts[1..-1].join(' ')

    if Howzit.options.key?(k.to_sym)
      Howzit.options[k.to_sym] = v.to_config_value(Howzit.options[k.to_sym])
    else
      puts "Key #{k} not found"
    end
    Howzit.config.write_config(Howzit.options)
    Process.exit 0
  end

  opts.on('--edit-config', "Edit configuration file using default $EDITOR") do
    Howzit.config.editor
    Process.exit 0
  end

  opts.on('--title-only', 'Output title only') do
    Howzit.options[:output_title] = true
    Howzit.options[:title_only] = true
  end

  opts.on('--templates', 'List available templates') do
    Dir.chdir(Howzit.config.template_folder)
    Dir.glob('*.md').each do |file|
      template = File.basename(file, '.md')
      puts Howzit::Color.template("{Mk}template:{Yk}#{template}{x}")
      puts Howzit::Color.template("{bk}[{bl}tasks{bk}]──────────────────────────────────────┐{x}")
      metadata = file.extract_metadata
      topics = Howzit.buildnote.read_file(file)
      topics.each do |topic|
        puts Howzit::Color.template(" {bk}│{bw}-{x} {bcK}#{template}:#{topic.title.sub(/^.*?:/, '')}{x}")
      end
      if metadata.size > 0
        meta = []
        meta << metadata['required'].split(/\s*,\s*/).map {|m| "*{bw}#{m}{xw}" } if metadata.key?('required')
        meta << metadata['optional'].split(/\s*,\s*/).map {|m| "#{m}" } if metadata.key?('optional')
        puts Howzit::Color.template("{bk}[{bl}meta{bk}]───────────────────────────────────────┤{x}")
        puts Howzit::Color.template(" {bk}│ {xw}#{meta.join(", ")}{x}")
      end
      puts Howzit::Color.template(" {bk}└───────────────────────────────────────────┘{x}")
    end
    Process.exit 0
  end

  opts.on('--header-format TYPE', HEADER_FORMAT_OPTIONS,
          "Formatting style for topic titles (#{HEADER_FORMAT_OPTIONS.join(', ')})") do |t|
    Howzit.options[:header_format] = t
  end

  opts.on('--[no-]color', 'Colorize output (default on)') do |c|
    Howzit.options[:color] = c
    Howzit.options[:highlight] = false unless c
  end

  opts.on('--[no-]md-highlight', 'Highlight Markdown syntax (default on), requires mdless or mdcat') do |m|
    Howzit.options[:highlight] = Howzit.options[:color] ? m : false
  end

  opts.on('--[no-]pager', 'Paginate output (default on)') do |p|
    Howzit.options[:paginate] = p
  end

  opts.on('-h', '--help', 'Display this screen') do
    puts opts
    Process.exit 0
  end

  opts.on('-v', '--version', 'Display version number') do
    puts "how v#{Howzit::VERSION}"
    Process.exit 0
  end

  opts.on('--default', 'Answer all prompts with default response') do
    Howzit.options[:default] = true
  end
end.parse!(args)

Howzit.options[:multiple_matches] = Howzit.options[:multiple_matches].to_sym
Howzit.options[:header_format] = Howzit.options[:header_format].to_sym

Howzit.cli_args = args
Howzit.buildnote.run
